{% extends "base.html" %}

{% block title %}{{ session }} | دستیار گفتگو{% endblock %}

{% block content %}
<div class="mx-auto max-w-4xl px-4 py-8 space-y-6">
    <header class="flex flex-wrap items-center justify-between gap-3">
        <div>
            <p class="text-sm text-slate-500">شناسه جلسه: {{ session.pk }}</p>
            <h1 class="text-2xl font-bold text-slate-900">{{ session }}</h1>
        </div>
        <a href="{% url 'chat:index' %}" class="inline-flex items-center justify-center rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-900">بازگشت به گفتگوها</a>
    </header>

    <section class="space-y-3">
        <div class="rounded-2xl border border-slate-200 bg-white/70 shadow-sm backdrop-blur">
            <div id="messages" class="h-[65vh] max-h-[70vh] overflow-y-auto p-4 space-y-4">
                {% for message in messages %}
                    <article class="flex items-start gap-3 rounded-xl border border-slate-100 bg-slate-50 px-3 py-2">
                        <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-full bg-slate-900 text-sm font-semibold text-white">
                            {{ message.get_role_display|slice:":1" }}
                        </div>
                        <div class="space-y-1">
                            <div class="text-sm font-semibold text-slate-700">{{ message.get_role_display }}</div>
                            <p class="leading-7 text-slate-800">{{ message.content }}</p>
                        </div>
                    </article>
                {% empty %}
                    <div class="flex h-full min-h-[200px] items-center justify-center rounded-xl border border-dashed border-slate-200 bg-slate-50 text-slate-500">
                        اولین پیام خود را ارسال کنید.
                    </div>
                {% endfor %}
            </div>
            <p id="status" class="px-4 pb-4 text-sm text-slate-500"></p>
        </div>
    </section>

    <section class="rounded-2xl border border-slate-200 bg-white/70 p-4 shadow-sm backdrop-blur">
        <form id="chat-form" method="post" action="{% url 'chat:send_message' session.pk %}" class="space-y-4">
            {% csrf_token %}
            <div class="space-y-2">
                <label for="message-input" class="text-sm font-semibold text-slate-700">پیام جدید</label>
                <textarea id="message-input" name="message" rows="3" required class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-slate-400 focus:outline-none focus:ring-1 focus:ring-slate-400" placeholder="پیام خود را بنویسید"></textarea>
            </div>
            <div class="flex flex-wrap items-center justify-between gap-3">
                <p class="text-xs text-slate-500">پاسخ دستیار به صورت زنده در بالا نمایش داده می‌شود.</p>
                <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-600">ارسال پیام</button>
            </div>
        </form>
    </section>
</div>

<script>
    const form = document.getElementById('chat-form');
    const messagesBox = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const statusEl = document.getElementById('status');

    function scrollToBottom() {
        messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    function appendMessage(role, content) {
        const wrapper = document.createElement('article');
        wrapper.className = 'flex items-start gap-3 rounded-xl border border-slate-100 bg-slate-50 px-3 py-2';

        const avatar = document.createElement('div');
        avatar.className = 'flex h-9 w-9 shrink-0 items-center justify-center rounded-full bg-slate-900 text-sm font-semibold text-white';
        avatar.textContent = role === 'user' ? 'ک' : role === 'assistant' ? 'د' : 'س';

        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'space-y-1';

        const roleLabel = document.createElement('div');
        roleLabel.className = 'text-sm font-semibold text-slate-700';
        roleLabel.textContent = role === 'user' ? 'کاربر' : role === 'assistant' ? 'دستیار' : 'سیستم';

        const text = document.createElement('p');
        text.className = 'leading-7 text-slate-800';
        text.textContent = content;

        contentWrapper.appendChild(roleLabel);
        contentWrapper.appendChild(text);
        wrapper.appendChild(avatar);
        wrapper.appendChild(contentWrapper);
        messagesBox.appendChild(wrapper);
        scrollToBottom();
    }

    async function streamAssistant(url, formData) {
        const response = await fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });

        if (!response.ok || !response.body) {
            statusEl.textContent = 'ارسال پیام با مشکل مواجه شد.';
            return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let assistantMessage = '';
        statusEl.textContent = 'در حال پاسخ...';

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, { stream: true });
            assistantMessage += chunk;
            const existing = document.getElementById('assistant-current');
            if (!existing) {
                const wrapper = document.createElement('article');
                wrapper.className = 'flex items-start gap-3 rounded-xl border border-slate-100 bg-slate-50 px-3 py-2';

                const avatar = document.createElement('div');
                avatar.className = 'flex h-9 w-9 shrink-0 items-center justify-center rounded-full bg-slate-900 text-sm font-semibold text-white';
                avatar.textContent = 'د';

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'space-y-1';

                const roleLabel = document.createElement('div');
                roleLabel.className = 'text-sm font-semibold text-slate-700';
                roleLabel.textContent = 'دستیار';

                const text = document.createElement('p');
                text.className = 'leading-7 text-slate-800';
                text.id = 'assistant-current';
                text.textContent = assistantMessage;

                contentWrapper.appendChild(roleLabel);
                contentWrapper.appendChild(text);
                wrapper.appendChild(avatar);
                wrapper.appendChild(contentWrapper);
                messagesBox.appendChild(wrapper);
            } else {
                existing.textContent = assistantMessage;
            }
            scrollToBottom();
        }

        const current = document.getElementById('assistant-current');
        if (current) {
            current.removeAttribute('id');
        }
        statusEl.textContent = '';
    }

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const text = messageInput.value.trim();
        if (!text) return;

        appendMessage('user', text);
        messageInput.value = '';

        const formData = new FormData(form);
        await streamAssistant(form.action, formData);
    });

    scrollToBottom();
</script>
{% endblock %}
